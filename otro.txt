import { useState } from "react";
import "../App.css";
import axios from 'axios';

function Model() {
    const [imagePreview, setImagePreview] = useState(null);
    const [prediccion, setPrediccion] = useState(null);
    const [nameImage, setNameImage] = useState('');

    const handleImageUpload = async (event) => {
        const file = event.target.files[0];
        if (!file) return; 

        console.log("Imagen seleccionada:", file.name);
        setNameImage(file.name); // Guardamos el nombre del archivo
        
        const formData = new FormData();
        formData.append('file', file);
        
        try {
            console.log("Subiendo imagen...");
            await axios.post('http://127.0.0.1:8000/upload', formData);
            console.log("Imagen subida con éxito");
        } catch (error) {
            console.error("Error subiendo la imagen:", error);
            return;
        }

        // Mostrar la vista previa de la imagen
        const reader = new FileReader();
        reader.onloadend = () => {
            console.log("Imagen lista para mostrar");
            setImagePreview(reader.result);
        };
        reader.readAsDataURL(file);
    };

    const handlePredict = async () => {
        if (!nameImage) {
            alert("Sube una imagen primero.");
            return;
        }

        console.log("Solicitando predicción para:", nameImage);

        try {
            const response = await axios.get(`http://127.0.0.1:8000/predecir/${nameImage}`);
            console.log("Respuesta de la API recibida:", response.data);

            let data = response.data;
            if (typeof data === 'string') {
                data = JSON.parse(data);
            }

            setPrediccion(data);
            console.log("Predicción guardada en estado:", data);
        } catch (error) {
            console.error("Error en la predicción:", error);
        }
    };

    return (
        <>
            <div className="container">
                <h1 className="text-center">AI-Ris Detección automática mediante Machine Learning</h1>
                <hr id="line" />
            </div>
            <div className="container text-center">
                <div className="row">
                    <div className="col">
                        <h2>Bienvenido a AI-ris</h2>
                        <p>AI-ris es un sistema de detección automática de enfermedades oculares mediante Machine Learning.</p>
                    </div>
                    <div className="col">
                        <h2>Analizar con AI-ris</h2>
                        <input 
                            type="file" 
                            id="image-upload" 
                            accept="image/*"
                            onChange={handleImageUpload}
                        />
                        <div className="preview-container">
                            {imagePreview ? (
                                <img src={imagePreview} alt="Vista previa de la imagen" className="image-preview" id='image'/>
                            ) : (
                                <p>No se ha seleccionado ninguna imagen.</p>
                            )}
                        </div>
                    </div>
                    <div className="col">
                        <h2>Resultados</h2>
                        <p>Sube una imagen y presiona "Analizar Imagen" para obtener un diagnóstico.</p>
                        <button className="btn btn-primary" onClick={handlePredict}>Analizar Imagen</button>
                        {prediccion && (
                            <div className="result-container">
                                <h3>Predicción:</h3>
                                <p>Clase: {prediccion.Clase}</p>
                                <p>Probabilidad: {prediccion.Probabilidad}</p>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        </>
    );
}

export default Model;
